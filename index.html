<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Focus</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ---------- layout & theme ---------- */
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  display: flex;
  flex-direction: column;
  height: 100vh;

  background: radial-gradient(
    circle at top left,
    #7E97FF 0%,
    #bdc3c7 45%,
    #2c3e50 100%
  );
}

/* Header + zones */
header, #dateStrip, #actionZone {
  padding: 8px;
}

/* Date strip (scrollable last 7 days) */
#dateStrip {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  white-space: nowrap;
  padding-bottom: 6px;
}
#dateStrip::-webkit-scrollbar { display: none; }

.date-item {
  min-width: 90px;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: center;
  cursor: pointer;
  flex-shrink: 0;
}
.date-item.active {
  background: #222;
  color: white;
}

#actionZone {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.45);
}

/* content anchor: make it take remaining height and scroll */
#contentAnchor {
  flex: 1;
  overflow: auto;
  background: rgba(255,255,255,0.06);
  border-radius: 18px;
  margin: 8px;
  padding: 12px;
}

/* Task list */
#taskList {
  width: 100%;
  padding: 8px 0;
}

/* Task row */
.task {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px;
  margin-bottom: 8px;
  border-radius: 6px;
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(255,255,255,0.35);
}
.task-text { flex: 1; font-family: "Copperplate", "Copperplate Gothic Light", serif; font-weight:500; }

/* difficulty colours */
.task.diff-1 .task-text { color: #2E7D32; }
.task.diff-2 .task-text { color: #0277BD; }
.task.diff-3 .task-text { color: #C62828; }

/* completed / missed / hover */
.task.completed { opacity: 0.75; transition: box-shadow .3s, opacity .3s; }
.task.incomplete-today { color: #222; }
.task.missed { color: #b71c1c; opacity: 0.8; }
.task.clickable { cursor: pointer; }
.task.read-only { cursor: default; }

.task-check { width:18px; height:18px; cursor:pointer; accent-color:#2e7d32; }
.diff-badge {
  margin-left:auto; padding: 2px 8px; border-radius:999px; font-weight:600; font-size:12px; line-height:1.2;
  font-family: system-ui, Arial Rounded MT Bold, Arial, sans-serif;
  background: rgba(255,255,255,0.55);
  box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}
.diff-badge.diff-1 { background:#4CAF50; color:#0b2e13; }
.diff-badge.diff-2 { background:#03A9F4; color:#012a3a; }
.diff-badge.diff-3 { background:#F44336; color:#3a0503; }

/* input and controls */
#newTaskInput {
  width:100%; height:56px; font-size:16px; padding:12px 14px; border-radius:12px; border:1px solid #ccc; box-sizing:border-box;
  background: rgba(255,255,255,0.85);
}
#difficultySelector { display:flex; gap:6px; margin-top:6px; }
.diff-btn { flex:1; padding:6px; border:1px solid #ccc; border-radius:6px; background: rgba(255,255,255,0.5); }
.diff-btn.active { background: rgba(0,0,0,0.8); color:white; }

/* action buttons */
#actionButtons { display:flex; gap:8px; margin-top:8px; }
#actionButtons button { flex:1; height:48px; font-size:16px; border-radius:10px; background: rgba(255,255,255,0.5); }

/* Panels - hidden by default so they don't show on first load */
#observationPanel, #statsPanel { display: none; color: #0e1320; }

/* stats card */
.statBlock { margin-top:12px; padding:10px; border-radius:8px; background: rgba(255,255,255,0.45); cursor:pointer; }
.statRow { display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid #ddd; }
.statRow:last-child { border-bottom:none; }

/* --------- SVG donut styles --------- */
#obsChartSvg {
  display: block;
  margin: 8px auto;
  width: 220px;
  height: 220px;
}
#obsChartSvg circle {
  fill: none;
  stroke-width: 20;
  stroke-linecap: round;
  transition: stroke-dashoffset 700ms ease;
}
#arcEasy { stroke: #4CAF50; }
#arcMedium { stroke: #03A9F4; }
#arcHard { stroke: #F44336; }

/* small responsive tweaks */
@media (min-width:900px){
  #contentAnchor { max-width:900px; margin-left:auto; margin-right:auto; }
}
</style>
</head>

<body>

<header>
  <h2>Daily Focus</h2>
  <p id="fullDate"></p>
</header>

<section id="dateStrip" aria-label="Date strip"></section>

<section id="actionZone">
  <input id="newTaskInput" placeholder="Add a task for today" aria-label="New task">
  <div id="difficultySelector" role="tablist" aria-label="Difficulty">
    <button class="diff-btn active" data-diff="1">Easy</button>
    <button class="diff-btn" data-diff="2">Medium</button>
    <button class="diff-btn" data-diff="3">Hard</button>
  </div>

  <div id="actionButtons">
    <button id="addTaskBtn">Add</button>
    <button id="observeBtn">Observation</button>
    <button id="statsBtn">Statistics</button>
  </div>
</section>

<!-- single content anchor (only one set of panels) -->
<div id="contentAnchor">

  <main id="taskList" aria-live="polite"></main>

  <section id="observationPanel" aria-hidden="true">
    <h3>Observation</h3>
    <p id="obsSummary"></p>

    <!-- SVG donut (replaces canvas) -->
    <svg id="obsChartSvg" viewBox="0 0 220 220" role="img" aria-label="Observation donut chart">
      <!-- rotate group so 0% starts at top -->
      <g transform="rotate(-90 110 110)">
        <circle id="arcEasy"   cx="110" cy="110" r="80" />
        <circle id="arcMedium" cx="110" cy="110" r="80" />
        <circle id="arcHard"   cx="110" cy="110" r="80" />
      </g>

      <text id="chartPercent" x="110" y="98" text-anchor="middle" font-size="22" font-weight="600" fill="#0e1320">0%</text>
      <text x="110" y="122" text-anchor="middle" font-size="12" fill="#0e1320">Completed</text>
    </svg>

    <p id="obsInsight"></p>
    <p id="weeklyInsight"></p>
  </section>

  <section id="statsPanel" aria-hidden="true">
    <h3>Statistics</h3>

    <div class="statBlock" onclick="toggleStatDetail(7)">
      <div class="statTitle" id="stat7Title"></div>
      <div class="statDetail" id="stat7Detail"></div>
    </div>

    <div class="statBlock" onclick="toggleStatDetail(14)">
      <div class="statTitle" id="stat14Title"></div>
      <div class="statDetail" id="stat14Detail"></div>
    </div>

    <div class="statBlock" onclick="toggleStatDetail(30)">
      <div class="statTitle" id="stat30Title"></div>
      <div class="statDetail" id="stat30Detail"></div>
    </div>

  </section>

</div>

<script>
const STORAGE_KEY = "daily-focus-data";

function getToday() {
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  return now.toLocaleDateString("en-CA"); // YYYY-MM-DD (local)
}

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { days:{}, activeDate:getToday() };
const today = getToday();
data.activeDate = today;
if (!data.days[today]) data.days[today] = [];
save(); // uses function below (hoisted)

document.getElementById("fullDate").textContent = new Date(today).toDateString();

/* Difficulty selector */
let selectedDifficulty = 1;
document.querySelectorAll(".diff-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".diff-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    selectedDifficulty = Number(b.dataset.diff);
  };
});

/* Dates */
function renderDateStrip() {
  const strip = document.getElementById("dateStrip");
  strip.innerHTML = "";

  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const ds = d.toISOString().split("T")[0];

    const item = document.createElement("div");
    item.className = "date-item";
    item.textContent = d.toLocaleDateString(undefined, {
      day: "numeric",
      month: "short"
    });

    if (ds === data.activeDate) item.classList.add("active");
    item.onclick = () => selectDate(ds);
    strip.appendChild(item);
  }
}

function selectDate(date){
  closePanels();
  data.activeDate = date;
  save();
  render();
}

/* Tasks rendering */
function renderTasks(){
  const list = document.getElementById("taskList");
  list.innerHTML = "";
  const tasks = data.days[data.activeDate] || [];
  const isToday = data.activeDate === today;

  if(!tasks.length){
    const p = document.createElement("div");
    p.textContent = "No tasks.";
    p.style.opacity = "0.8";
    list.appendChild(p);
    return;
  }

  tasks.forEach((t, i) => {
    const row = document.createElement("div");
    row.className = "task";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "task-check";
    checkbox.checked = !!t.completed;
    checkbox.disabled = !isToday;

    checkbox.onclick = (e) => {
      e.stopPropagation();
      toggleTask(i);
    };

    const label = document.createElement("span");
    label.className = "task-text";
    label.textContent = t.text;

    const badge = document.createElement("span");
    badge.className = `diff-badge diff-${t.difficulty}`;
    badge.textContent =
      t.difficulty === 1 ? "Easy" :
      t.difficulty === 2 ? "Medium" : "Hard";

    row.classList.add(`diff-${t.difficulty}`);
    row.append(checkbox, label, badge);

    if (t.completed) row.classList.add("completed");
    else if (!isToday) row.classList.add("missed");
    else row.classList.add("incomplete-today");

    if (isToday) {
      row.classList.add("clickable");
      row.onclick = () => toggleTask(i);
    } else {
      row.classList.add("read-only");
    }

    list.appendChild(row);
  });
}

function toggleTask(i){
  const day = data.activeDate;
  if (!data.days[day] || !data.days[day][i]) return;
  const t = data.days[day][i];
  t.completed = !t.completed;
  save();
  renderTasks();
}

document.getElementById("addTaskBtn").onclick = () => {
  if (data.activeDate !== today) return;
  const inp = document.getElementById("newTaskInput");
  if (!inp.value.trim()) return;
  data.days[today].push({
    text: inp.value.trim(),
    completed: false,
    difficulty: selectedDifficulty
  });
  inp.value = "";
  save();
  renderTasks();
};

/* Observation helpers */
function getRecentDates(days) {
  const dates = [];
  for (let i = 0; i < days; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    dates.push(d.toISOString().split("T")[0]);
  }
  return dates;
}

function analyzeBehavior() {
  const dates = getRecentDates(7);
  let assigned = 0, completed = 0;
  const taskStats = {};

  dates.forEach(date => {
    (data.days[date] || []).forEach(t => {
      const w = t.difficulty || 1;
      assigned += w;
      if (t.completed) completed += w;

      if (!taskStats[t.text]) taskStats[t.text] = { completed: 0, missed: 0 };
      t.completed ? taskStats[t.text].completed++ : taskStats[t.text].missed++;
    });
  });

  if (assigned >= 5 && completed / assigned < 0.5) {
    return "You seem to be taking on more than you can sustain right now. Consider reducing task volume or difficulty.";
  }

  for (const [task, stat] of Object.entries(taskStats)) {
    if (stat.missed >= 3 && stat.missed > stat.completed) {
      return `“${task}” appears repeatedly missed. Consider lowering its difficulty or breaking it down.`;
    }
  }

  if (assigned > 0 && completed / assigned >= 0.8) {
    return "Your workload and completion feel well balanced lately.";
  }

  return "";
}

const INSIGHT_KEY = "df_last_insight";

function canShowInsight(message) {
  if (!message) return false;
  const last = JSON.parse(localStorage.getItem(INSIGHT_KEY));
  const now = Date.now();
  if (!last) return true;
  const sameMessage = last.message === message;
  const withinCooldown = now - last.time < 48 * 60 * 60 * 1000;
  return !(sameMessage && withinCooldown);
}

function saveInsight(message) {
  localStorage.setItem(INSIGHT_KEY, JSON.stringify({ message, time: Date.now() }));
}

function evaluateFinalInsight() {
  const behaviorMessage = analyzeBehavior();
  if (!behaviorMessage) return "";
  if (canShowInsight(behaviorMessage)) {
    saveInsight(behaviorMessage);
    return behaviorMessage;
  }
  return "";
}

/* RENDER OBSERVATION -> uses SVG donut */
function renderObservation(){
  const tasks = data.days[data.activeDate] || [];
  let completed = 0, missed = 0;
  tasks.forEach(t=>{
    const w = t.difficulty || 1;
    if (t.completed) completed += w;
    else missed += w;
  });

  document.getElementById("obsSummary").textContent = `Effort completed: ${completed}, Effort missed: ${missed}`;
  drawSvgDonut(completed, missed);

  let dailyInsight = "";
  if (completed === 0 && missed > 0) {
    dailyInsight = "All planned effort was missed today. Consider lowering task difficulty.";
  } else if (completed > 0 && missed === 0) {
    dailyInsight = "You completed everything you planned today. Effort balance looks good.";
  } else if (completed >= missed) {
    dailyInsight = "More effort was completed than missed. Consistency is forming.";
  } else {
    dailyInsight = "Missed effort outweighs completion. Review task difficulty or volume.";
  }
  document.getElementById("obsInsight").textContent = dailyInsight;
  document.getElementById("weeklyInsight").textContent = evaluateFinalInsight();
}

/* SVG donut drawing function */
<svg id="obsChart" width="220" height="220" viewBox="0 0 220 220">
  <!-- background ring -->
  <circle
    cx="110"
    cy="110"
    r="80"
    fill="none"
    stroke="rgba(255,255,255,0.25)"
    stroke-width="16"
  />

  <!-- progress ring -->
  <circle
    id="progressRing"
    cx="110"
    cy="110"
    r="80"
    fill="none"
    stroke="#4CAF50"
    stroke-width="16"
    stroke-linecap="round"
    stroke-dasharray="0 999"
    transform="rotate(-90 110 110)"
  />

  <!-- center text -->
  <text x="110" y="105" text-anchor="middle" font-size="26" font-weight="600" fill="#222">
    <tspan id="percentText">0%</tspan>
  </text>
  <text x="110" y="130" text-anchor="middle" font-size="14" fill="#333">
    Completed
  </text>
</svg>

  const sum = easy + medium + hard;
  const percent = (completed + missed) ? Math.round((completed / (completed + missed)) * 100) : 0;
  document.getElementById("chartPercent").textContent = `${percent}%`;

  const arcEasy = document.getElementById("arcEasy");
  const arcMedium = document.getElementById("arcMedium");
  const arcHard = document.getElementById("arcHard");

  // radius must match SVG circle r
  const r = 80;
  const C = 2 * Math.PI * r;

  // prepare circles
  [arcEasy, arcMedium, arcHard].forEach(c => {
    if (!c) return;
    c.style.transition = "stroke-dashoffset 700ms ease";
    c.setAttribute("stroke-dasharray", `${C} ${C}`);
    // start from zero (hidden)
    c.style.strokeDashoffset = C;
  });

  if (!sum) {
    // nothing completed — keep circles hidden
    return;
  }

  // compute lengths
  const lenEasy = (easy / sum) * C;
  const lenMedium = (medium / sum) * C;
  const lenHard = (hard / sum) * C;

  // target offsets (place arcs in sequence easy -> medium -> hard)
  const targetEasy = C - lenEasy;
  const targetMedium = C - lenEasy - lenMedium;
  const targetHard = C - lenEasy - lenMedium - lenHard;

  // set dasharray per arc to clip lengths (so only segment visible)
  arcEasy.setAttribute("stroke-dasharray", `${lenEasy} ${C}`);
  arcMedium.setAttribute("stroke-dasharray", `${lenMedium} ${C}`);
  arcHard.setAttribute("stroke-dasharray", `${lenHard} ${C}`);

  // small timeout to ensure transition from initial value runs
  requestAnimationFrame(() => {
    // also use another rAF to be safe on some browsers
    requestAnimationFrame(() => {
      arcEasy.style.strokeDashoffset = targetEasy;
      arcMedium.style.strokeDashoffset = targetMedium;
      arcHard.style.strokeDashoffset = targetHard;
    });
  });
}

/* Statistics helpers */
function getDaySummary(dateStr){
  const t = data.days[dateStr] || [];
  return { assigned: t.length, completed: t.filter(x=>x.completed).length };
}

function buildStat(days){
  let completed = 0, assigned = 0, html = "";
  for (let i=0; i<days; i++){
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().split("T")[0];
    const s = getDaySummary(ds);
    assigned += s.assigned;
    completed += s.completed;
    html += `<div class="statRow"><span>${d.toDateString().slice(0,10)}</span><span>${s.completed} / ${s.assigned}</span></div>`;
  }
  return { title:`Last ${days} days - Completed ${completed} / Assigned ${assigned}`, detail: html };
}

function toggleStatDetail(d){
  const el = document.getElementById(`stat${d}Detail`);
  if (!el) return;
  el.style.display = el.style.display === "block" ? "none" : "block";
}

/* Panels handlers (TOGGLE SAFE) */

// Observation toggle
document.getElementById("observeBtn").onclick = () => {
  const panel = document.getElementById("observationPanel");
  const taskList = document.getElementById("taskList");

  const isOpen = window.getComputedStyle(panel).display !== "none";

  if (isOpen) {
    closePanels(); // close & show tasks
    return;
  }

  closePanels();
  taskList.style.display = "none";
  panel.style.display = "block";
  renderObservation();
};

// Statistics toggle
document.getElementById("statsBtn").onclick = () => {
  const panel = document.getElementById("statsPanel");
  const taskList = document.getElementById("taskList");

  const isOpen = window.getComputedStyle(panel).display !== "none";

  if (isOpen) {
    closePanels(); // close & show tasks
    return;
  }

  closePanels();
  taskList.style.display = "none";
  panel.style.display = "block";

  [7, 14, 30].forEach(d => {
    const r = buildStat(d);
    const titleEl = document.getElementById(`stat${d}Title`);
    const detailEl = document.getElementById(`stat${d}Detail`);

    titleEl.textContent = r.title;
    detailEl.innerHTML = r.detail;

    // FORCE details closed on open
    detailEl.style.display = "none";
  });
};

function closePanels(){
  const taskListEl = document.getElementById("taskList");
  if (taskListEl) taskListEl.style.display = "block";

  const obs = document.getElementById("observationPanel");
  const sp = document.getElementById("statsPanel");
  if (obs) { obs.style.display = "none"; obs.setAttribute("aria-hidden","true"); }
  if (sp) { sp.style.display = "none"; sp.setAttribute("aria-hidden","true"); }
}

function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

function syncToday() {
  const realToday = getToday();
  if (data.activeDate === realToday) return;
  if (!data.days[data.activeDate]) {
    data.activeDate = realToday;
    if (!data.days[realToday]) data.days[realToday] = [];
    save();
  }
}

document.addEventListener("visibilitychange", () => {
  if (!document.hidden) render();
});

function render(){
  syncToday();
  renderDateStrip();
  renderTasks();
  closePanels(); // keep panels hidden by default
}

render();
</script>
</body>
</html>
