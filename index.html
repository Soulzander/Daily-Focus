<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7E97FF">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Daily Focus</title>

<style>
/* ---------- layout & theme ---------- */
:root {
  --glass-bg: rgba(255,255,255,0.06);
  --panel-glass: rgba(255,255,255,0.45);
}
html,body { 
  height: 100%; 
  min-height: 100vh; /* Add this */
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  display: flex;
  flex-direction: column;
  min-height: 100vh; /* Changed from height to min-height */
  background: radial-gradient(circle at top left,#7E97FF 0%, #bdc3c7 45%, #2c3e50 100%);
  background-attachment: fixed; /* This keeps gradient fixed during scroll */
  color:#0e1320;
}

}

header, #dateStrip, #actionZone { padding: 8px; }

/* Date strip */
#dateStrip {
  display:flex;
  gap:8px;
  overflow-x:auto;
  white-space:nowrap;
  padding-bottom:6px;
}
#dateStrip::-webkit-scrollbar { display:none; }

.date-item {
  min-width:90px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.35);
  text-align:center;
  cursor:pointer;
  flex-shrink:0;
  background: rgba(255,255,255,0.5);
  color: #1b2430;
}
.date-item.active {
  background: #222;
  color: white;
  border:1px solid rgba(0,0,0,0.6);
}

/* action zone */
#actionZone {
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(255,255,255,0.45);
}

/* content anchor container */
#contentAnchor {
  flex: 1;
  overflow:auto;
  background: var(--glass-bg);
  border-radius: 18px;
  margin: 8px;
  padding: 12px;
}

/* controls */
#newTaskInput {
  width:100%;
  height:56px;
  font-size:16px;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #ccc;
  box-sizing:border-box;
  background: rgba(255,255,255,0.85);
}
#difficultySelector { display:flex; gap:6px; margin-top:6px; }
.diff-btn { 
  flex:1; 
  padding:6px; 
  border:1px solid #ccc; 
  border-radius:6px; 
  background: rgba(255,255,255,0.5); 
  cursor: pointer;
}
.diff-btn.active { background: rgba(0,0,0,0.8); color:white; }

/* action buttons */
#actionButtons { display:flex; gap:8px; margin-top:8px; }
#actionButtons button { 
  flex:1; 
  height:48px; 
  font-size:16px; 
  border-radius:10px; 
  background: rgba(255,255,255,0.5); 
  cursor: pointer; 
  border: 1px solid #ccc;
}

/* task list */
#taskList { width:100%; padding:8px 0; }
.task {
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  margin-bottom:8px;
  border-radius:10px;
  background: rgba(255,255,255,0.55);
  border:1px solid rgba(255,255,255,0.35);
}
.task-text { flex:1; font-weight:500; }
.task-check { width:20px; height:20px; cursor:pointer; accent-color:#2e7d32; }
.diff-badge { margin-left:auto; padding:4px 8px; border-radius:999px; font-weight:600; font-size:12px; }
.diff-badge.diff-1 { background:#4CAF50; color:#05260f; }
.diff-badge.diff-2 { background:#03A9F4; color:#012a3a; }
.diff-badge.diff-3 { background:#F44336; color:#3a0503; }
.task.completed { opacity:0.8; }
.task.clickable { cursor: pointer; }

/* observation / stats panels */
#observationPanel, #statsPanel { display:none; color:#0e1320; }

/* SVG donut */
#obsChartSvg { display:block; margin:8px auto; width:220px; height:220px; }
#obsChartSvg circle { 
  fill:none; 
  stroke-width:20; 
  stroke-linecap:round; 
  transition: stroke-dashoffset 800ms ease, stroke 400ms ease; 
}

@media(min-width:900px){
  #contentAnchor { max-width:900px; margin-left:auto; margin-right:auto; }
}

.statBlock {
  background: rgba(255,255,255,0.45);
  backdrop-filter: blur(14px);
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 12px;
  cursor: pointer;
}
.statDetail { display: none; margin-top: 10px; }
</style>

</head>
<body>

<header>
  <h2>Daily Focus</h2>
  <p id="fullDate"></p>
</header>

<section id="dateStrip" aria-label="Date strip"></section>

<section id="actionZone">
  <input id="newTaskInput" placeholder="Add a task for today" aria-label="New task">
  <div id="difficultySelector">
    <button class="diff-btn active" data-diff="1">Easy</button>
    <button class="diff-btn" data-diff="2">Medium</button>
    <button class="diff-btn" data-diff="3">Hard</button>
  </div>

  <div id="actionButtons">
    <button id="addTaskBtn">Add</button>
    <button id="observeBtn">Observation</button>
    <button id="statsBtn">Statistics</button>
  </div>
</section>

<div id="contentAnchor">
  <main id="taskList" aria-live="polite"></main>

  <section id="observationPanel" aria-hidden="true">
    <h3>Observation</h3>
    <p id="obsSummary"></p>
    <svg id="obsChartSvg" viewBox="0 0 220 220">
      <circle id="bgRing" cx="110" cy="110" r="80" stroke="rgba(200,200,200,0.3)" />
      <circle id="arcEasy" cx="110" cy="110" r="80" transform="rotate(-90 110 110)" stroke="#4CAF50" />
      <circle id="arcMedium" cx="110" cy="110" r="80" transform="rotate(-90 110 110)" stroke="#03A9F4" />
      <circle id="arcHard" cx="110" cy="110" r="80" transform="rotate(-90 110 110)" stroke="#F44336" />
      <text x="110" y="98" text-anchor="middle" font-size="22" font-weight="600" fill="#0e1320">
        <tspan id="chartPercent">0%</tspan>
      </text>
      <text x="110" y="122" text-anchor="middle" font-size="12" fill="#0e1320">Completed</text>
    </svg>
    <p id="obsInsight"></p>
    <p id="weeklyInsight"></p>
  </section>

  <section id="statsPanel" aria-hidden="true">
    <h3>Statistics</h3>
    <div class="statBlock" onclick="toggleStatDetail(7)">
      <div class="statTitle" id="stat7Title"></div>
      <div class="statDetail" id="stat7Detail"></div>
    </div>
    <div class="statBlock" onclick="toggleStatDetail(14)">
      <div class="statTitle" id="stat14Title"></div>
      <div class="statDetail" id="stat14Detail"></div>
    </div>
    <div class="statBlock" onclick="toggleStatDetail(30)">
      <div class="statTitle" id="stat30Title"></div>
      <div class="statDetail" id="stat30Detail"></div>
    </div>
  </section>
</div>

<script>
/* ------------------------------
   Data & helpers
   ------------------------------ */
const STORAGE_KEY = "daily-focus-data";

function getToday() {
  // Return YYYY-MM-DD in local time using en-CA formatting
  return new Date().toLocaleDateString("en-CA");
}

let data = (() => {
  try {
    const stored = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { days:{} };
    // ALWAYS set activeDate to today when app opens
    stored.activeDate = getToday();
    return stored;
  } catch (e) {
    return { days:{}, activeDate:getToday() };
  }
})();

const today = getToday();
// ensure today exists
if (!data.days[today]) data.days[today] = [];
save();

function save(){ 
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch(e) {
    console.error("Save error:", e);
  }
}

let selectedDifficulty = 1;
document.querySelectorAll(".diff-btn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".diff-btn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    selectedDifficulty = Number(b.dataset.diff);
  };
});

function renderDateStrip() {
  const strip = document.getElementById("dateStrip");
  if (!strip) return;
  strip.innerHTML = "";

  for (let i = 0; i < 7; i++) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const ds = d.toLocaleDateString("en-CA");
    const label = d.toLocaleDateString(undefined, { day: "numeric", month: "short" });

    const item = document.createElement("div");
    item.className = "date-item";
    item.textContent = label;

    if (ds === data.activeDate) item.classList.add("active");
    item.onclick = () => selectDate(ds);
    strip.appendChild(item);
  }
}

function selectDate(date){
  closePanels();
  data.activeDate = date;
  save();
  render();
}

function renderTasks(){
  const list = document.getElementById("taskList");
  if (!list) return;
  list.innerHTML = "";
  
  const tasks = data.days[data.activeDate] || [];
  const isToday = data.activeDate === today;

  if(!tasks.length){
    list.innerHTML = '<div style="opacity:0.8">No tasks.</div>';
    return;
  }

  tasks.forEach((t, i) => {
    const row = document.createElement("div");
    row.className = "task";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "task-check";
    checkbox.checked = !!t.completed;
    checkbox.disabled = !isToday;
    checkbox.onclick = (e) => {
      e.stopPropagation();
      toggleTask(i);
    };

    const label = document.createElement("span");
    label.className = "task-text";
    label.textContent = t.text;

    const badge = document.createElement("span");
    badge.className = `diff-badge diff-${t.difficulty}`;
    badge.textContent = t.difficulty === 1 ? "Easy" : t.difficulty === 2 ? "Medium" : "Hard";

    row.append(checkbox, label, badge);
    if (t.completed) row.classList.add("completed");
    if (isToday) {
      row.classList.add("clickable");
      row.onclick = () => toggleTask(i);
    }

    list.appendChild(row);
  });
}

function toggleTask(i){
  if (!data.days[data.activeDate] || !data.days[data.activeDate][i]) return;
  data.days[data.activeDate][i].completed = !data.days[data.activeDate][i].completed;
  save();
  renderTasks();
}

document.getElementById("addTaskBtn").onclick = () => {
  if (data.activeDate !== today) return;
  const inp = document.getElementById("newTaskInput");
  if (!inp.value.trim()) return;
  
  if (!data.days[today]) data.days[today] = [];
  data.days[today].push({
    text: inp.value.trim(),
    completed: false,
    difficulty: selectedDifficulty
  });
  inp.value = "";
  save();
  renderTasks();
};

function drawSvgDonut(completedWeighted, totalWeighted) {
  const arcEasy = document.getElementById("arcEasy");
  const arcMedium = document.getElementById("arcMedium");
  const arcHard = document.getElementById("arcHard");
  const percentEl = document.getElementById("chartPercent");

  if (!arcEasy || !arcMedium || !arcHard || !percentEl) return;

  let easyWeighted = 0, mediumWeighted = 0, hardWeighted = 0;

  (data.days[data.activeDate] || []).forEach(t => {
    if (!t.completed) return;
    const weight = t.difficulty || 1;
    if (t.difficulty === 1) easyWeighted += weight;
    else if (t.difficulty === 2) mediumWeighted += weight;
    else if (t.difficulty === 3) hardWeighted += weight;
  });

  const totalCompleted = easyWeighted + mediumWeighted + hardWeighted;
  const percent = totalWeighted > 0 ? Math.round((completedWeighted / totalWeighted) * 100) : 0;
  percentEl.textContent = `${percent}%`;

  const r = 80;
  const C = 2 * Math.PI * r;

  [arcEasy, arcMedium, arcHard].forEach(c => {
    c.setAttribute("stroke-dasharray", `0 ${C}`);
    c.style.strokeDashoffset = 0;
  });

  if (totalCompleted === 0) return;

  const lenEasy = (easyWeighted / totalCompleted) * C * (percent / 100);
  const lenMedium = (mediumWeighted / totalCompleted) * C * (percent / 100);
  const lenHard = (hardWeighted / totalCompleted) * C * (percent / 100);

  let currentOffset = 0;

  if (lenEasy > 0) {
    arcEasy.setAttribute("stroke-dasharray", `${lenEasy} ${C}`);
    arcEasy.style.strokeDashoffset = -currentOffset;
    currentOffset += lenEasy;
  }

  if (lenMedium > 0) {
    arcMedium.setAttribute("stroke-dasharray", `${lenMedium} ${C}`);
    arcMedium.style.strokeDashoffset = -currentOffset;
    currentOffset += lenMedium;
  }

  if (lenHard > 0) {
    arcHard.setAttribute("stroke-dasharray", `${lenHard} ${C}`);
    arcHard.style.strokeDashoffset = -currentOffset;
  }
}

function renderObservation(){
  const tasks = data.days[data.activeDate] || [];
  let completedWeighted = 0, totalWeighted = 0;
  
  tasks.forEach(t=>{
    const w = t.difficulty || 1;
    totalWeighted += w;
    if (t.completed) completedWeighted += w;
  });

  const missedWeighted = totalWeighted - completedWeighted;
  document.getElementById("obsSummary").textContent = `Effort completed: ${completedWeighted}, Effort missed: ${missedWeighted}`;
  drawSvgDonut(completedWeighted, totalWeighted);

  let dailyInsight = "";
  if (completedWeighted === 0 && missedWeighted > 0) {
    dailyInsight = "All planned effort was missed today.";
  } else if (completedWeighted > 0 && missedWeighted === 0) {
    dailyInsight = "You completed everything you planned today!";
  } else if (completedWeighted >= missedWeighted) {
    dailyInsight = "More effort was completed than missed.";
  } else {
    dailyInsight = "Missed effort outweighs completion.";
  }
  document.getElementById("obsInsight").textContent = dailyInsight;
  document.getElementById("weeklyInsight").textContent = "";
}

function getDaySummary(dateStr){
  const t = data.days[dateStr] || [];
  return { assigned: t.length, completed: t.filter(x=>x.completed).length };
}

function buildStat(days){
  let completed = 0, assigned = 0, html = "";
  for (let i=0; i<days; i++){
    const d = new Date(); 
    d.setDate(d.getDate()-i);
    const ds = d.toLocaleDateString("en-CA");
    const s = getDaySummary(ds);
    assigned += s.assigned;
    completed += s.completed;
    html += `<div style="display:flex; justify-content:space-between; padding:4px 0;"><span>${d.toDateString().slice(0,10)}</span><span>${s.completed} / ${s.assigned}</span></div>`;
  }
  return { title:`Last ${days} days - Completed ${completed} / Assigned ${assigned}`, detail: html };
}

function toggleStatDetail(d){
  const el = document.getElementById(`stat${d}Detail`);
  if (!el) return;
  el.style.display = el.style.display === "block" ? "none" : "block";
}

document.getElementById("observeBtn").onclick = () => {
  const panel = document.getElementById("observationPanel");
  const taskList = document.getElementById("taskList");
  const isOpen = panel.style.display === "block";
  
  closePanels();
  if (!isOpen) {
    taskList.style.display = "none";
    panel.style.display = "block";
    renderObservation();
  }
};

document.getElementById("statsBtn").onclick = () => {
  const panel = document.getElementById("statsPanel");
  const taskList = document.getElementById("taskList");
  const isOpen = panel.style.display === "block";
  
  closePanels();
  if (!isOpen) {
    taskList.style.display = "none";
    panel.style.display = "block";

    [7,14,30].forEach(d => {
      const r = buildStat(d);
      document.getElementById(`stat${d}Title`).textContent = r.title;
      document.getElementById(`stat${d}Detail`).innerHTML = r.detail;
      document.getElementById(`stat${d}Detail`).style.display = "none";
    });
  }
};

function closePanels(){
  const taskList = document.getElementById("taskList");
  const obs = document.getElementById("observationPanel");
  const sp = document.getElementById("statsPanel");
  
  if (taskList) taskList.style.display = "block";
  if (obs) obs.style.display = "none";
  if (sp) sp.style.display = "none";
}

function render(){
  const fullDateEl = document.getElementById("fullDate");
  if (fullDateEl) {
    fullDateEl.textContent = new Date(data.activeDate).toDateString();
  }
  renderDateStrip();
  renderTasks();
  closePanels();
}

document.addEventListener("visibilitychange", () => {
  if (!document.hidden) render();
});

// Initialize
save();
render();
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js")
      .then(reg => console.log("SW registered:", reg))
      .catch(err => console.log("SW registration failed:", err));
  });
}
</script>

</body>
</html>
